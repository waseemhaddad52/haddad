def branchName               =  "main"
def gitUrl                   =  "https://github.com/waseemhaddad52/haddad.git"
def serviceName              =  "hello-world"
def EnvName                  =  "dev"
def imageTag                 =  "${EnvName}_${BUILD_NUMBER}"
def awsRegion                =  "us-east-2"
def ecrUrl                   =  "727245885999.dkr.ecr.us-east-2.amazonaws.com"



node () {
    cleanWs()
        
        script {
            properties([
                parameters([
                    string(defaultValue: 'main', name: 'branchName')
                ])
            ])
        }

        stage ("Code Checkout") {
            checkout([$class: 'GitSCM', branches: [[name: "${branchName}"]], extensions: [], userRemoteConfigs: [[url: "${gitUrl}"]]] )
            sh "rm -rf .git"   
        }

        stage ('ECR Login') {
            sh "aws ecr get-login-password --region ${awsRegion} | docker login --username AWS --password-stdin ${ecrUrl}"
        }  

        stage ('Docker Build') {
            dir('Docker') {
                sh "docker build -t ${ecrUrl}/${serviceName}:${imageTag} ."
            }
        }

        stage ('Docker Push') {
            sh "docker push ${ecrUrl}/${serviceName}:${imageTag}"
        }  

      

        stage('Remove Local Images') {
            sh "docker rmi -f ${ecrUrl}/${imageTag} || :"
        }   
    } 
